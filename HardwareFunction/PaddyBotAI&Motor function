import time
import serial
import pyautogui
from ultralytics import YOLO

# Load trained YOLOv8 model
model = YOLO("best.pt")  # Replace with your model path

# Connect to Arduino (change COM port if needed)
arduino = serial.Serial("COM3", 9600, timeout=1)
time.sleep(2)  # Let Arduino initialize

def detect_disease(image_path):
    results = model(image_path)
    detections = results[0].boxes.xywh.cpu().numpy()  # (x_center, y_center, width, height)

    if len(detections) == 0:
        print("No disease detected.")
        return None

    # For simplicity, use the first detection
    x_center, y_center, _, _ = detections[0]
    print(f"Disease detected at: X={x_center}, Y={y_center}")
    print(f"Damn thats crazy") 
    return int(x_center)

def send_coordinate_to_arduino(x_ticks):
    # Send the number of ticks to Arduino
    message = f"{x_ticks}\n"
    arduino.write(message.encode())
    print(f"Sent to Arduino: {message.strip()}")

def take_screenshot():
    screenshot = pyautogui.screenshot()
    screenshot.save("disease_screenshot.png")
    print("Screenshot saved!")

# Main routine
image_path = "paddy_image.jpg"  # Replace with your input image
x_coord = detect_disease(image_path)

if x_coord is not None:
    send_coordinate_to_arduino(x_coord)
    time.sleep(10)  # wait for Arduino to reach the location
    take_screenshot()
    print("Waiting for Arduino to return...")
    time.sleep(10)
else:
    print("No action taken.")
